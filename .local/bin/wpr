#!/bin/bash
# ┌────────────────────────────────────────────────────────────────────────────┐
# │                            WPR - WALLPAPER SWITCHER                        │
# └────────────────────────────────────────────────────────────────────────────┘
# [INFO] A minimalist, text-only wallpaper manager for Wofi.

# ┌────────────────────────────────────────────────────────────────────────────┐
# │                               1. CONFIGURATION                             │
# └────────────────────────────────────────────────────────────────────────────┘

# [CONFIG] Core paths, consistent with your environment.
WALLPAPER_DIR="$HOME/Pictures/walls"
STATE_FILE="$HOME/.config/pyre/state"

# [CONFIG] Your preferred swww transition effect is stored here for reuse.
TRANSITION_EFFECT="--transition-type grow --transition-pos 0.5,0.5 --transition-duration 1.2 --transition-fps 60"

# ┌────────────────────────────────────────────────────────────────────────────┐
# │                              2. CORE FUNCTIONS                             │
# └────────────────────────────────────────────────────────────────────────────┘

# --- Show Usage ---
show_usage() {
  echo "Usage: wpr [command]"
  echo "  <no_command>   Interactively select wallpaper from the current theme."
  echo "  -r, --random   Set a random wallpaper from the current theme."
  echo "  -a, --all      Interactively select from ALL wallpapers, ignoring themes."
  echo "  -h, --help     Show this help message."
}

# --- Set Wallpaper ---
set_wallpaper() {
  local wallpaper_path="$1"
  if [[ -f "$wallpaper_path" ]]; then
    eval "swww img \"$wallpaper_path\" $TRANSITION_EFFECT"
    notify-send -t 3000 " Wallpaper Changed" "$(basename "$wallpaper_path")" -i "preferences-desktop-wallpaper"
  else
    notify-send "WPR Error" "Wallpaper file not found." -i "dialog-error"
    exit 1
  fi
}

# ┌────────────────────────────────────────────────────────────────────────────┐
# │                                3. EXECUTION                                │
# └────────────────────────────────────────────────────────────────────────────┘

# --- Step 1: Handle Help Argument ---
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  show_usage
  exit 0
fi

# --- Step 2: Determine Wallpaper Source Directory ---
source_dir="$WALLPAPER_DIR" # Default to root dir
current_theme=""

if [[ -f "$STATE_FILE" ]]; then
  current_theme=$(<"$STATE_FILE")
  if [[ -d "$WALLPAPER_DIR/$current_theme" ]]; then
    source_dir="$WALLPAPER_DIR/$current_theme"
  fi
fi

if [[ "$1" == "-a" || "$1" == "--all" ]]; then
  source_dir="$WALLPAPER_DIR"
fi

# --- Step 3: Validate Source Directory ---
if [[ ! -d "$source_dir" ]]; then
  notify-send "WPR Error" "Source directory not found:\n$source_dir" -i "dialog-error"
  exit 1
fi

# --- Step 4: Execute Action Based on Command ---
case "$1" in
# --- Action: Random ---
-r | --random)
  wallpaper=$(find "$source_dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) | shuf -n 1)
  if [[ -z "$wallpaper" ]]; then
    notify-send "WPR Error" "No images found in:\n$source_dir" -i "dialog-error"
    exit 1
  fi
  set_wallpaper "$wallpaper"
  ;;

# --- Action: Interactive (Text-Only) ---
*)
  # [FINAL] Generate a simple, sorted list of basenames for wofi.
  selected_filename=$(find "$source_dir" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.gif" \) -exec basename {} \; |
    sort |
    wofi --dmenu --prompt " Select Wallpaper:" --width 500 --height 600 -i)

  if [[ -n "$selected_filename" ]]; then
    # [INFO] Wofi returns only the filename. We must find the full path again.
    # Using `head -n 1` ensures we only get one result if there are duplicates.
    full_path=$(find "$source_dir" -type f -name "$selected_filename" | head -n 1)

    if [[ -n "$full_path" ]]; then
      set_wallpaper "$full_path"
    fi
  fi
  ;;
esac
