#!/bin/bash

# Скрипт для автоматического обновления базы данных AIDE

# --- Цвета для вывода ---
C_RED='\033[1;31m'
C_GREEN='\033[1;32m'
C_YELLOW='\033[1;33m'
C_BLUE='\033[1;34m'
C_NC='\033[0m' # No Color

# --- Функция для вывода заголовков ---
print_header() {
    printf "\n${C_BLUE}=================================================================${C_NC}\n"
    printf "${C_BLUE}  $1${C_NC}\n"
    printf "${C_BLUE}=================================================================${C_NC}\n"
}

# --- Проверка на запуск с правами root ---
if [ "$EUID" -ne 0 ]; then
  printf "${C_RED}Ошибка: Этот скрипт должен быть запущен с sudo.${C_NC}\n"
  exit 1
fi

# --- Определение путей к базам данных ---
DB_PATH="/var/lib/aide"
DB_CURRENT="${DB_PATH}/aide.db.gz"
DB_NEW="${DB_PATH}/aide.db.new.gz"

# --- Шаг 1: Запуск процесса обновления AIDE ---
print_header "Запуск 'aide --update' для поиска изменений"
aide --update
AIDE_STATUS=$?

# --- Шаг 2: Анализ результата и замена базы данных ---
if [ $AIDE_STATUS -eq 0 ]; then
    print_header "Завершение обновления"
    if [ -f "$DB_NEW" ]; then
        printf "${C_GREEN}Обнаружены изменения. Установка новой базы данных...${C_NC}\n"
        mv "$DB_NEW" "$DB_CURRENT"
        printf "${C_GREEN}База данных AIDE успешно обновлена.${C_NC}\n"
    else
        printf "${C_YELLOW}Изменений в файловой системе не обнаружено. База данных осталась прежней.${C_NC}\n"
    fi
else
    printf "${C_RED}Ошибка: 'aide --update' завершился с кодом %s. База данных не обновлена.${C_NC}\n" "$AIDE_STATUS"
    exit 1
fi

exit 0
