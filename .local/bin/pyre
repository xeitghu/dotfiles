#!/bin/bash
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                         â•‘
# â•‘                           PYRE ENGINE                                   â•‘
# â•‘                                                                         â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                 PATHS & SETTINGS                 â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# ïŸ™ Core paths used by the engine
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
STATE_FILE="$HOME/.config/pyre/state"
SCRIPTS_DIR="$HOME/.config/hypr/scripts"
ENGINE_THEMES_DIR="$HOME/.config/hypr/engine/themes"
WAL_CACHE_DIR="$HOME/.cache/wal"

# =================================================================
#                         CORE FUNCTIONS
# =================================================================
# --- Dependency Check ---
check_dependencies() {
  local missing=0
  # ïš Check for all required commands
  for cmd in wofi swww kitty notify-send; do
    if ! command -v "$cmd" &>/dev/null; then
      notify-send "Pyre Error" "Required command not found: $cmd" -i "dialog-error"
      missing=1
    fi
  done
  # ïš Check for all required directories
  for dir in "$WALLPAPER_DIR" "$ENGINE_THEMES_DIR" "$SCRIPTS_DIR"; do
    if [ ! -d "$dir" ]; then
      notify-send "Pyre Error" "Required directory not found: $dir" -i "dialog-error"
      missing=1
    fi
  done
  [ "$missing" -eq 1 ] && exit 1
}

# --- Reload Services ---
reload_services() {
  hyprctl reload
  pkill -SIGUSR2 waybar
  pkill dunst && dunst &
}

# =================================================================
#                        LAYOUT LAUNCHERS
# =================================================================
# --- Showcase Layout ---
launch_showcase_layout() {
  # ï„µ Load temporary window layout configuration
  hyprctl keyword source ~/.config/hypr/showcase.conf
  sleep 0.2
  kitty -o font_size=10.0 --title "hollywood-clock" tty-clock -c -C 2 &
  sleep 0.2
  kitty -o font_size=10.0 --title "hollywood-cava" cava &
  sleep 0.2
  kitty -o font_size=10.0 --title "hollywood-matrix" unimatrix &
  sleep 0.2
  kitty -o font_size=10.0 --title "hollywood-pipes" pipes.sh &
}

# --- F0urth Layout ---
launch_f0urth_layout_simple() {
  local small_font_size=8
  kitty -o font_size=$small_font_size &
  sleep 0.3
  local directions=("r" "d" "l")
  for dir in "${directions[@]}"; do
    hyprctl dispatch movefocus "$dir"
    kitty -o font_size=$small_font_size &
    sleep 0.3
  done
}

# --- Fastfetch Layout ---
launch_fastfetch_layout() {
  # ï„µ Load temporary window layout configuration
  hyprctl keyword source ~/.config/hypr/pyre_layouts.conf
  sleep 0.1
  kitty --title "pyre-fastfetch" \
    -o font_size=10.0 \
    -o window_padding_width=0 \
    -o scrollback_lines=0 \
    sh -c "tput civis; fastfetch; sleep infinity" &
}

# --- Dual Pane Layout ---
launch_dual_pane_layout() {
  # ï„µ Load and clear temporary configurations
  hyprctl keyword source ~/.config/hypr/filemanager.conf
  thunar &
  sleep 0.5
  kitty -o font_size=10.0 --title "fm-yazi" yazi &
  sleep 1
  hyprctl keyword source ~/.config/hypr/filemanager_clear.conf
}

# =================================================================
#                   ENGINE: THEME & WALLPAPER
# =================================================================
# --- Apply Mocha Theme ---
apply_theme() {
  local theme_name_lower=$1
  local theme_name_capitalized
  theme_name_capitalized=$(echo "$theme_name_lower" | awk '{print toupper(substr($0,1,1))substr($0,2)}')

  # ïš ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¼Ğ°ÑÑ‚ĞµÑ€-Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ñ‚ĞµĞ¼ Ğ² Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹.
  cp "$ENGINE_THEMES_DIR/hypr/$theme_name_lower.conf" "$HOME/.config/hypr/theme.conf"
  cp "$ENGINE_THEMES_DIR/waybar/$theme_name_lower.css" "$HOME/.config/waybar/theme.css"
  cp "$ENGINE_THEMES_DIR/wofi/$theme_name_lower.css" "$HOME/.config/wofi/theme.css"

  # ïš Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ¾Ğ¸ Ğ¸Ğ· Ğ¿Ğ°Ğ¿ĞºĞ¸ Ñ‚ĞµĞ¼Ñ‹.
  local theme_wallpaper_dir="$WALLPAPER_DIR/$theme_name_lower"
  if [ -d "$theme_wallpaper_dir" ]; then
    local wallpaper
    wallpaper=$(find "$theme_wallpaper_dir" -type f | shuf -n 1)
    [ -n "$wallpaper" ] && swww img "$wallpaper" --transition-type wipe --transition-angle 30 --transition-step 90
  fi

  reload_services
  notify-send "ğŸ¨ Pyre: Theme Changed" "Palette activated: $theme_name_capitalized" -i "preferences-desktop-theme"
}

# =================================================================
#                       MENUS & DISPATCHER
# =================================================================
# --- Theme Menu ---
show_theme_menu() {
  local options="ï†† Mocha"
  local choice
  choice=$(printf "%b" "$options" | wofi --dmenu --prompt "Select Theme:" --width 300 --height 100)
  if [ -n "$choice" ]; then
    local theme_name
    theme_name=$(echo "$choice" | sed -e 's/ï†† //' | tr '[:upper:]' '[:lower:]')
    apply_theme "$theme_name"
  fi
}

# --- Layout Selection Menu ---
show_layout_menu() {
  local options=("ó°„› Showcase" "ï„Š F0urth" "ï„ˆ Fastfetch" "ï„§ Dual Pane")
  local choice
  choice=$(printf "%s\n" "${options[@]}" | wofi --dmenu --prompt "Select Layout:" --width 300 --height 170)
  case "$choice" in
  "ó°„› Showcase") (launch_showcase_layout) & ;;
  "ï„Š F0urth") (launch_f0urth_layout_simple) & ;;
  "ï„ˆ Fastfetch") (launch_fastfetch_layout) & ;;
  "ï„§ Dual Pane") (launch_dual_pane_layout) & ;;
  esac
}

# --- Session Menu (Power + Lock) ---
show_session_menu() {
  local options="ï€‘ Power\nï€£ Lock"
  local choice
  choice=$(printf "%b" "$options" | wofi --dmenu --prompt "Session Control:" --width 300 --height 100)
  case "$choice" in
  "ï€‘ Power") "$SCRIPTS_DIR/powermenu.sh" ;;
  "ï€£ Lock") "$SCRIPTS_DIR/lockscreen.sh" ;;
  esac
}

# --- Tools Menu (Screenshot + Clipboard) ---
show_tools_menu() {
  local options="ï€° Screenshot\nï‡š Clipboard"
  local choice
  choice=$(printf "%b" "$options" | wofi --dmenu --prompt "Tools:" --width 300 --height 100)
  case "$choice" in
  "ï€° Screenshot") "$SCRIPTS_DIR/screenshot.sh" ;;
  "ï‡š Clipboard") "$SCRIPTS_DIR/clipboard_history.sh" ;;
  esac
}

# --- Main Menu ---
show_main_menu() {
  local state_file="$HOME/.config/pyre/main_menu_last_choice"
  local options=("ï‡¼ Themes" "ï„› Layouts" "ï‚­ Tools" "ó°’ƒ Session")
  local menu_string

  if [ -f "$state_file" ] && last_choice=$(<"$state_file"); then
    local other_options=$(printf "%s\n" "${options[@]}" | grep -vF -- "$last_choice")
    menu_string="$last_choice\n$other_options"
  else
    menu_string=$(printf "%s\n" "${options[@]}")
  fi

  local choice=$(echo -e "$menu_string" | wofi --dmenu --prompt "Pyre Mission Control:" --width 300 --height 170)

  if [ -n "$choice" ]; then
    echo "$choice" >"$state_file"
    case "$choice" in
    "ï‡¼ Themes") show_theme_menu ;;
    "ï„› Layouts") show_layout_menu ;;
    "ï‚­ Tools") show_tools_menu ;;
    "ó°’ƒ Session") show_session_menu ;;
    esac
  fi
}

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                SCRIPT ENTRY POINT                â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
check_dependencies

case "$1" in
theme) show_theme_menu ;;
layout) show_layout_menu ;;
*) show_main_menu ;;
esac
