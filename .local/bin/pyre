#!/bin/bash
# =================================================================
#         PYRE ENGINE (v11.0 - "–°–∏–Ω—Ç–µ–∑")
# =================================================================
# –ì–∏–±—Ä–∏–¥–Ω–∞—è –≤–µ—Ä—Å–∏—è: –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å + —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –º–µ–Ω—é.

# --- –ü–£–¢–ò –ò –ù–ê–°–¢–†–û–ô–ö–ò (–∏–∑ –≤–∞—à–µ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏) ---
WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
STATE_FILE="$HOME/.config/pyre/state"
SCRIPTS_DIR="$HOME/.config/hypr/scripts"

# --- –§–£–ù–ö–¶–ò–ò (–∏–∑ –≤–∞—à–µ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏, –æ–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã (–º–æ—â–Ω–∞—è, —Å wal)
apply_theme() {
    local theme_name_lower=$1
    local theme_name_capitalized=$(echo "$theme_name_lower" | awk '{print toupper(substr($0,1,1))substr($0,2)}')
    local ENGINE_THEMES_DIR="$HOME/.config/hypr/engine/themes"
    local HYPR_THEMES="$ENGINE_THEMES_DIR/hypr"
    local WAYBAR_THEMES="$ENGINE_THEMES_DIR/waybar"
    local KITTY_THEMES="$ENGINE_THEMES_DIR/kitty"
    local DUNST_THEMES="$ENGINE_THEMES_DIR/dunst"
    local WAL_CACHE_DIR="$HOME/.cache/wal"
    cp "$HYPR_THEMES/$theme_name_lower.conf" "$WAL_CACHE_DIR/colors-hyprland.conf"
    cp "$WAYBAR_THEMES/$theme_name_lower.css" "$WAL_CACHE_DIR/colors-waybar.css"
    cp "$KITTY_THEMES/$theme_name_lower.conf" "$WAL_CACHE_DIR/colors-kitty.conf"
    cp "$DUNST_THEMES/$theme_name_lower.dunstrc" "$WAL_CACHE_DIR/colors-dunst"
    hyprctl reload
    pkill -SIGUSR2 waybar
    pkill dunst && dunst &
    kitty @ set-colors --all --configured "$WAL_CACHE_DIR/colors-kitty.conf"
    THEME_WALLPAPER_DIR="$WALLPAPER_DIR/$theme_name_lower"
    if [ -d "$THEME_WALLPAPER_DIR" ]; then
        wallpaper=$(find "$THEME_WALLPAPER_DIR" -type f | shuf -n 1)
        if [ -n "$wallpaper" ]; then
            swww img "$wallpaper" --transition-type wipe --transition-angle 30 --transition-step 90
        fi
    fi
    echo "$theme_name_capitalized" > "$STATE_FILE"
    notify-send "üé® Pyre: –¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞" "–ê–∫—Ç–∏–≤–Ω–∞ –ø–∞–ª–∏—Ç—Ä–∞: $theme_name_capitalized" -i "preferences-desktop-theme"
}

# –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –æ–±–æ–µ–≤ (–º–æ—â–Ω–∞—è, —Å wal)
set_random_wallpaper() {
    if [ ! -d "$WALLPAPER_DIR" ] || [ -z "$(ls -A "$WALLPAPER_DIR")" ]; then
        notify-send "Pyre Error" "–ü–∞–ø–∫–∞ —Å –æ–±–æ—è–º–∏ –ø—É—Å—Ç–∞" -i "dialog-error"; return
    fi
    local wallpaper=$(find "$WALLPAPER_DIR" -type f | shuf -n 1)
    swww img "$wallpaper" --transition-type wipe --transition-angle 30 --transition-step 90
    wal -i "$wallpaper" -q -n -s
    hyprctl reload
    pkill -SIGUSR2 waybar
    pkill dunst && dunst &
    kitty @ set-colors --all --configured ~/.cache/wal/colors-kitty.conf
    echo "random" > "$STATE_FILE"
    notify-send "ÔÄæ Pyre: –û–±–æ–∏ –∏–∑–º–µ–Ω–µ–Ω—ã" "–ü–∞–ª–∏—Ç—Ä–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏–∑:\n$(basename "$wallpaper")" -i "preferences-desktop-wallpaper"
}

# --- –ì–õ–ê–í–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö (–ì–ò–ë–†–ò–î–ù–ê–Ø –õ–û–ì–ò–ö–ê) ---
case "$1" in
theme)
    # --- –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –ú–ï–ù–Æ ---
    
    # 1. –í–∞—à–∏ –Ω–æ–≤—ã–µ, –∫—Ä–∞—Å–∏–≤—ã–µ –∏–∫–æ–Ω–∫–∏
    theme_options="ÔÜÖ Latte\nÔÜÜ Mocha\nÔÅ¨ Frapp√©\nÔãú Macchiato"
    
    # 2. –í—ã–∑—ã–≤–∞–µ–º wofi —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ —Å—Ç–∏–ª—è
    chosen_theme=$(printf "%b" "$theme_options" | wofi --dmenu --prompt "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É:" --width 300 --height 170)
    
    if [ -n "$chosen_theme" ]; then
        # --- –í–û–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ---
        # –û–±–Ω–æ–≤–ª—è–µ–º sed, —á—Ç–æ–±—ã –æ–Ω —É–±–∏—Ä–∞–ª –í–ê–®–ò –ù–û–í–´–ï –∏–∫–æ–Ω–∫–∏
        theme_name_only=$(echo "$chosen_theme" | sed -e 's/ÔÜÖ //' -e 's/ÔÜÜ //' -e 's/ÔÅ¨ //' -e 's/Ôãú //')
        
        # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏
        theme_to_apply=$(echo "$theme_name_only" | tr '[:upper:]' '[:lower:]')
        apply_theme "$theme_to_apply"
    fi
    ;;
    wallpaper)
        set_random_wallpaper
        ;;
    power)
        $SCRIPTS_DIR/powermenu.sh
        ;;
    screenshot)
        $SCRIPTS_DIR/screenshot.sh
        ;;
    clipboard)
        $SCRIPTS_DIR/clipboard_history.sh
        ;;
    lock)
        $SCRIPTS_DIR/lockscreen.sh
        ;;
    *)
        # --- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (–∏–∑ –≤–∞—à–µ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏, —Å–æ –≤—Å–µ–º–∏ –æ–ø—Ü–∏—è–º–∏) ---
        options="Ôáº Theme\nÔÄæ Wallpaper\nÔÄë Power\nÔÄ∞ Screenshot\nÔáö Clipboard\nÔÄ£ Lock"
        choice=$(printf "%b" "$options" | wofi --dmenu --prompt "Pyre Mission Control:" --width 300 --height 250)

        case "$choice" in
            "Ôáº Theme")
                $0 theme
                ;;
            "ÔÄæ Wallpaper")
                $0 wallpaper
                ;;
            "ÔÄë Power")
                $0 power
                ;;
            "ÔÄ∞ Screenshot")
                $0 screenshot
                ;;
            "Ôáö Clipboard")
                $0 clipboard
                ;;
            "ÔÄ£ Lock")
                $0 lock
                ;;
        esac
        ;;
esac
