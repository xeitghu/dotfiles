#!/usr/bin/env zsh
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                            BRIGHTNESS MANAGER                              â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# [INFO] Adaptive time-based brightness controller with user override detection.

# --- Configuration ---
# [CONFIG] Set your preferred day/night brightness levels (in percent).
BRIGHTNESS_DAY=90
BRIGHTNESS_NIGHT=30

# [INFO] Paths for the lock file and log file.
LOCK_FILE="/tmp/auto_brightness_disabled"
LOG_FILE="$HOME/.cache/brightness-manager.log"

# --- Helper Functions ---
# [INFO] A standardized logging function.
# [EXAMPLE] log "This is a message"
log() {
	# [INFO] Ensure the log directory exists before writing.
	mkdir -p "$(dirname "$LOG_FILE")"
	print -r "$(date '+%F %T') | $1" >>"$LOG_FILE"
}

# --- Core Logic ---
# [INFO] Check for a lock file to allow the user to temporarily disable the script.
if [[ -f "$LOCK_FILE" ]]; then
	log "ðŸ”’ Auto brightness disabled by user (lock file present)"
	exit 0
fi

# [INFO] Determine target brightness based on the time of day.
integer HOUR=$(date +%H)
if ((HOUR >= 19 || HOUR < 9)); then
	TARGET=$BRIGHTNESS_NIGHT
else
	TARGET=$BRIGHTNESS_DAY
fi

# [INFO] Get current and maximum brightness from the system.
integer CURRENT=$(brightnessctl g 2>/dev/null)
integer MAX=$(brightnessctl m 2>/dev/null)
if ((MAX == 0)); then
	log "âš ï¸  Failed to read max brightness. Exiting."
	exit 1
fi

integer PERCENT=$((CURRENT * 100 / MAX))

# [INFO] Calculate the difference to detect if the user has manually set brightness.
#        The script will not override a recent manual adjustment.
integer DIFF=$((PERCENT > TARGET ? PERCENT - TARGET : TARGET - PERCENT))

if ((DIFF > 10)); then
	log "â­ï¸  User override detected (current=$PERCENT%, target=$TARGET%). Skipping adjustment."
	exit 0
fi

# [INFO] Apply the new brightness level.
brightnessctl set "${TARGET}%" &>/dev/null
log "ðŸŒ— Adjusted brightness to ${TARGET}% (current was ${PERCENT}%)"
