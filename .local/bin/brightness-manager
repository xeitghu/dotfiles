#!/usr/bin/env zsh
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚             BRIGHTNESS MANAGER (SMART)           â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# [INFO] Adaptive time-based brightness controller with user override detection.

# --- Configuration ---
BRIGHTNESS_DAY=90
BRIGHTNESS_NIGHT=30
LOCK_FILE="/tmp/auto_brightness_disabled"
LOG_FILE="$HOME/.cache/brightness-manager.log"

mkdir -p "$(dirname "$LOG_FILE")"

# --- Helper function for logging ---
log() {
  print -r "$(date '+%F %T') | $1" >>"$LOG_FILE"
}

# --- Skip if locked ---
if [[ -f "$LOCK_FILE" ]]; then
  log "ðŸ”’ Auto brightness disabled by user (lock file present)"
  exit 0
fi

# --- Determine current time ---
integer HOUR=$(date +%H)
if ((HOUR >= 21 || HOUR < 8)); then
  TARGET=$BRIGHTNESS_NIGHT
else
  TARGET=$BRIGHTNESS_DAY
fi

# --- Get current brightness ---
integer CURRENT=$(brightnessctl g 2>/dev/null)
integer MAX=$(brightnessctl m 2>/dev/null)
((MAX == 0)) && {
  log "âš ï¸ Failed to read max brightness"
  exit 1
}

integer PERCENT=$((CURRENT * 100 / MAX))

# --- Compute absolute difference ---
integer DIFF=$((PERCENT > TARGET ? PERCENT - TARGET : TARGET - PERCENT))

# --- Only adjust if within 10% of target ---
if ((DIFF > 10)); then
  log "â­  User override detected (current=$PERCENT%, target=$TARGET%) â€” skipping"
  exit 0
fi

# --- Apply brightness ---
brightnessctl set "${TARGET}%" &>/dev/null
log "ðŸŒ— Adjusted brightness to ${TARGET}% (current was ${PERCENT}%)"
